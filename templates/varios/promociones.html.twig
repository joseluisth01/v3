{% extends 'base.html.twig' %}

{% block title %}Promociones - {{ config.title }}{% endblock %}

{% block body %}
<main>
    <section class="container mt-5" style="max-width:100% !important">
        <h1 class="text-center quienes-somos-title">Promociones</h1>
        <br><br>

        {% if promociones is not empty %}
            <div class="row" style="justify-content:center">
                {% for promo in promociones %}
                    {% set url_weburl = (promo.referencia|lower|replace({
                        '/': '-',
                        '[': '',
                        ']': '',
                        '(': '',
                        ')': '',
                        ' ': '-'
                    }) ~ '-' ~ promo.nombre|replace({
                        '/': '-',
                        '[': '',
                        ']': '',
                        '(': '',
                        ')': '',
                        'ñ': '-',
                        'Ñ': '-',
                        ' ': '-',
                        ',': '',
                        '.': '',
                        ':': '',
                        ';': '',
                        '"': '',
                        "'": '',
                        '&': '',
                        '#': '',
                        '@': '',
                        '!': '',
                        '?': '',
                        '¿': '',
                        '¡': '',
                        '+': '',
                        '*': '',
                        '=': '',
                        '{': '',
                        '}': ''
                    })|lower|trim('-')) %}
                    
                    {# Crear ruta de imagen inteligente que verifique múltiples posibilidades #}
                    {% set imagen_filename = null %}
                    
                    {# Verificar si tenemos ya una imagen guardada en el registro de promociones #}
                    {% if promo.imagen is defined and promo.imagen is not empty %}
                        {% set imagen_filename = promo.imagen %}
                    {% else %}
                        {# Intentar con formato de nombre basado en la referencia #}
                        {% set imagen_path_1 = 'images/cache/' ~ (promo.nombre|replace({
                            'ñ': '-', 'Ñ': '-', ' ': '-', '[': '', ']': '', '(': '', ')': '', '/': '-', ',': '', '.': ''
                        }) ~ '-' ~ promo.referencia)|lower ~ '-1-250.webp' %}
                        
                        {# Intentar con formato de nombre basado solo en el nombre del producto #}
                        {% set imagen_path_2 = 'images/cache/' ~ promo.referencia|lower ~ '-1-250.webp' %}
                        
                        {# Si la referencia es "BT50A/00", usar la URL específica para este caso #}
                        {% if promo.referencia == 'BT50A/00' %}
                            {% set imagen_path_3 = 'images/cache/altavoces-philips-bt50b-portatil-bluetooth-azul-bt50a-00-1-250.webp' %}
                        {% else %}
                            {% set imagen_path_3 = '' %}
                        {% endif %}
                        
                        {# Usar imagen por defecto #}
                        {% set imagen_path_default = 'images/default/no-image-250.webp' %}
                        
                        {# Seleccionar la imagen de la lista intentando en orden #}
                        {% set imagen_filename = imagen_path_3 is not empty ? imagen_path_3 : (imagen_path_1) %}
                    {% endif %}
                    
                    <div class="col-md-4 mb-4 itempromociones">
                        <a href="{{ path('articulo', {'weburl': url_weburl}) }}" class="text-decoration-none text-dark">
                            <div class="card h-100 cardpromociones">
                                <img style="height:200px !important; object-fit:contain" 
                                     src="{{ asset(imagen_filename) }}" 
                                     class="card-img-top" 
                                     alt="{{ promo.nombre }}"
                                     onerror="this.src='{{ asset('images/default/no-image-250.webp') }}'">
                                <div class="card-body">
                                    <h5 style="" class="nombrearticulo">{{ promo.nombre }}</h5>
                                    <p class="card-text promotions">
                                        <strong>Ref.</strong> {{ promo.referencia }}<br>
                                        <strong>Inicio promoción:</strong> {{ promo.fecha_creacion|date('d/m/Y') }}
                                    </p>
                                    <p style="text-align:center; margin-bottom:-15px !important" class="totalapagar">
                                        {{ promo.precio is not null ? promo.precio|number_format(2, '.', ',') ~ ' €' : 'N/A' }}
                                    </p>
                                </div>
                                <a class="btnanadircarrito" href="{{ path('articulo', {'weburl': url_weburl}) }}">SABER MÁS</a>
                                <br>
                            </div>
                        </a>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <p class="text-center">No hay promociones disponibles actualmente.</p>
        {% endif %}
    </section>

    <script>
        // Script para detectar y manejar imágenes no encontradas en promociones
document.addEventListener('DOMContentLoaded', function() {
    // Función para verificar si la imagen existe y establecer una ruta alternativa
    function tryLoadImage(img, referencia, nombre) {
        // Función llamada cuando la imagen no se carga correctamente
        img.onerror = function() {
            // Intentar con otras rutas alternativas
            const ref = referencia.toLowerCase().replace('/', '-');
            const name = nombre.toLowerCase()
                .replace(/ñ/g, 'n')
                .replace(/[áàäâ]/g, 'a')
                .replace(/[éèëê]/g, 'e')
                .replace(/[íìïî]/g, 'i')
                .replace(/[óòöô]/g, 'o')
                .replace(/[úùüû]/g, 'u')
                .replace(/[^a-z0-9]/g, '-')
                .replace(/-+/g, '-')
                .trim('-');
            
            // Alternativa 1: Imagen con nombre completo del producto seguido de la referencia
            const alt1 = `/v3/images/cache/${name}-${ref}-1-250.webp`;
            
            // Alternativa 2: Imagen con solo la referencia
            const alt2 = `/v3/images/cache/${ref}-1-250.webp`;
            
            // Alternativa 3: Caso especial para el producto "BT50A/00"
            const alt3 = (referencia === 'BT50A/00') 
                ? '/v3/images/cache/altavoces-philips-bt50b-portatil-bluetooth-azul-bt50a-00-1-250.webp' 
                : null;
            
            // Imagen por defecto como último recurso
            const defaultImg = '/v3/images/default/no-image-250.webp';
            
            // Intenta cargar la primera alternativa
            const testImg = new Image();
            testImg.onload = function() {
                img.src = alt1;
            };
            testImg.onerror = function() {
                // Si la primera alternativa falla, intenta la segunda
                const testImg2 = new Image();
                testImg2.onload = function() {
                    img.src = alt2;
                };
                testImg2.onerror = function() {
                    // Si la segunda alternativa falla, intenta la tercera si existe
                    if (alt3) {
                        const testImg3 = new Image();
                        testImg3.onload = function() {
                            img.src = alt3;
                        };
                        testImg3.onerror = function() {
                            // Si todo falla, usa la imagen por defecto
                            img.src = defaultImg;
                        };
                        testImg3.src = alt3;
                    } else {
                        // Si no hay tercera alternativa, usa la imagen por defecto
                        img.src = defaultImg;
                    }
                };
                testImg2.src = alt2;
            };
            testImg.src = alt1;
            
            // Importante: evitar recursión infinita
            img.onerror = null;
        };
    }
    
    // Buscar todas las imágenes en las tarjetas de promociones
    const promoCards = document.querySelectorAll('.itempromociones');
    promoCards.forEach(function(card) {
        const img = card.querySelector('img');
        const ref = card.querySelector('.card-text strong + br').previousSibling.textContent.trim().replace('Ref.', '').trim();
        const nombre = card.querySelector('.nombrearticulo').textContent.trim();
        
        if (img) {
            // Aplicar el manejo de errores a cada imagen
            tryLoadImage(img, ref, nombre);
        }
    });
});
    </script>
</main>
{% endblock %}